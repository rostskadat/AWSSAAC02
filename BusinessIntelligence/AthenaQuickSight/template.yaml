AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  AthenaQuickSight. Demonstrate the use of Athena and QuickSight
Metadata:
  AWS::ServerlessRepo::Application:
    Name: "AthenaQuickSight-AthenaQuickSight"
    Description: Demonstrate the use of Athena and QuickSight
    Author: rostskadat
    SpdxLicenseId: Apache-2.0
    ReadmeUrl: README.md
    Labels: [ "SAPC01", "AthenaQuickSight" ]
    HomePageUrl: https://github.com/rostskadat
    SemanticVersion: 0.0.1
    SourceCodeUrl: https://github.com/rostskadat

  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Parameters related to Athena
        Parameters:
          - AthenaDB

Parameters:

  ZTFAlertsDB:
    Type: String
    Description: The name of the DB where to store the log table
    Default: ZTFAlertsDB


Resources:

  Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    Properties:
      Tags:
        - Key: PLATFORM
          Value: SAPC01

  CreateDatabaseNamedQuery:
    Type: AWS::Athena::NamedQuery
    Properties:
      Database:
        Ref: ZTFAlertsDB
      Description: "Construct the ZTFAlerts DB"
      Name:
        Fn::Sub: "00-Create ZTFAlerts DB"
      QueryString:
        Fn::Sub: |
          CREATE DATABASE ${ZTFAlertsDB};

  CreateTableNamedQuery:
    Type: AWS::Athena::NamedQuery
    Properties:
      Database:
        Ref: ZTFAlertsDB
      Description: "Construct the Candidate table"
      Name:
        Fn::Sub: "01-Create Candidate Table"
      QueryString:
        Fn::Sub: |
          -- DROP TABLE ${ZTFAlertsDB}.ZTFAlerts;
          CREATE EXTERNAL TABLE IF NOT EXISTS ${ZTFAlertsDB}.ZTFAlerts (
              schemavsn STRING COMMENT "schema version used",
              publisher STRING COMMENT "origin of alert packet",
              objectId STRING COMMENT "object identifier or name",
              candid BIGINT,
              candidate STRUCT<
                  jd:DOUBLE COMMENT "Observation Julian date at start of exposure [days]",
                  fid:INT COMMENT "Filter ID (1=g; 2=R; 3=i)",
                  pid:BIGINT COMMENT "Processing ID for science image to facilitate archive retrieval",
                  diffmaglim:FLOAT COMMENT "Expected 5-sigma mag limit in difference image based on global noise estimate [mag]",
                  pdiffimfilename:STRING COMMENT "filename of positive (sci minus ref) difference image",
                  programpi:STRING COMMENT "Principal investigator attached to program ID",
                  programid:INT COMMENT "Program ID: encodes either public, collab, or caltech mode",
                  candid:BIGINT COMMENT "Candidate ID from operations DB",
                  isdiffpos:STRING COMMENT "t or 1 => candidate is from positive (sci minus ref) subtraction; f or 0 => candidate is from negative (ref minus sci) subtraction",
                  tblid:BIGINT COMMENT "Internal pipeline table extraction ID",
                  nid:INT COMMENT "Night ID",
                  rcid:INT COMMENT "Readout channel ID [00 .. 63]",
                  field:INT COMMENT "ZTF field ID",
                  xpos:FLOAT COMMENT "x-image position of candidate [pixels]",
                  ypos:FLOAT COMMENT "y-image position of candidate [pixels]",
                  ra:DOUBLE COMMENT "Right Ascension of candidate; J2000 [deg]",
                  declination:DOUBLE COMMENT "Declination of candidate; J2000 [deg]",
                  magpsf:FLOAT COMMENT "Magnitude from PSF-fit photometry [mag]",
                  sigmapsf:FLOAT COMMENT "1-sigma uncertainty in magpsf [mag]",
                  chipsf:FLOAT COMMENT "Reduced chi-square for PSF-fit",
                  magap:FLOAT COMMENT "Aperture mag using 14 pixel diameter aperture [mag]",
                  sigmagap:FLOAT COMMENT "1-sigma uncertainty in magap [mag]",
                  distnr:FLOAT COMMENT "distance to nearest source in reference image PSF-catalog [pixels]",
                  magnr:FLOAT COMMENT "magnitude of nearest source in reference image PSF-catalog [mag]",
                  sigmagnr:FLOAT COMMENT "1-sigma uncertainty in magnr [mag]",
                  chinr:FLOAT COMMENT "DAOPhot chi parameter of nearest source in reference image PSF-catalog",
                  sharpnr:FLOAT COMMENT "DAOPhot sharp parameter of nearest source in reference image PSF-catalog",
                  sky:FLOAT COMMENT "Local sky background estimate [DN]",
                  magdiff:FLOAT COMMENT "Difference: magap - magpsf [mag]",
                  fwhm:FLOAT COMMENT "Full Width Half Max assuming a Gaussian core, from SExtractor [pixels]",
                  classtar:FLOAT COMMENT "Star/Galaxy classification score from SExtractor",
                  mindtoedge:FLOAT COMMENT "Distance to nearest edge in image [pixels]",
                  magfromlim:FLOAT COMMENT "Difference: diffmaglim - magap [mag]",
                  seeratio:FLOAT COMMENT "Ratio: difffwhm / fwhm",
                  aimage:FLOAT COMMENT "Windowed profile RMS afloat major axis from SExtractor [pixels]",
                  bimage:FLOAT COMMENT "Windowed profile RMS afloat minor axis from SExtractor [pixels]",
                  aimagerat:FLOAT COMMENT "Ratio: aimage / fwhm",
                  bimagerat:FLOAT COMMENT "Ratio: bimage / fwhm",
                  elong:FLOAT COMMENT "Ratio: aimage / bimage",
                  nneg:INT COMMENT "number of negative pixels in a 5 x 5 pixel stamp",
                  nbad:INT COMMENT "number of prior-tagged bad pixels in a 5 x 5 pixel stamp",
                  rb:FLOAT COMMENT "RealBogus quality score from Random Forest classifier; range is 0 to 1 where closer to 1 is more reliable",
                  ssdistnr:FLOAT COMMENT "distance to nearest known solar system object if exists within 30 arcsec [arcsec]",
                  ssmagnr:FLOAT COMMENT "magnitude of nearest known solar system object if exists within 30 arcsec (usually V-band from MPC archive) [mag]",
                  ssnamenr:STRING COMMENT "name of nearest known solar system object if exists within 30 arcsec (from MPC archive)",
                  sumrat:FLOAT COMMENT "Ratio: sum(pixels) / sum(|pixels|) in a 5 x 5 pixel stamp where stamp is first median-filtered to mitigate outliers",
                  magapbig:FLOAT COMMENT "Aperture mag using 18 pixel diameter aperture [mag]",
                  sigmagapbig:FLOAT COMMENT "1-sigma uncertainty in magapbig [mag]",
                  ranr:DOUBLE COMMENT "Right Ascension of nearest source in reference image PSF-catalog; J2000 [deg]",
                  decnr:DOUBLE COMMENT "Declination of nearest source in reference image PSF-catalog; J2000 [deg]",
                  sgmag1:FLOAT COMMENT "g-band PSF-fit magnitude of closest source from PS1 catalog; if exists within 30 arcsec [mag]",
                  srmag1:FLOAT COMMENT "r-band PSF-fit magnitude of closest source from PS1 catalog; if exists within 30 arcsec [mag]",
                  simag1:FLOAT COMMENT "i-band PSF-fit magnitude of closest source from PS1 catalog; if exists within 30 arcsec [mag]",
                  szmag1:FLOAT COMMENT "z-band PSF-fit magnitude of closest source from PS1 catalog; if exists within 30 arcsec [mag]",
                  sgscore1:FLOAT COMMENT "Star/Galaxy score of closest source from PS1 catalog; if exists within 30 arcsec: 0 <= sgscore <= 1 where closer to 1 implies higher likelihood of being a star",
                  distpsnr1:FLOAT COMMENT "Distance to closest source from PS1 catalog; if exists within 30 arcsec [arcsec]",
                  ndethist:INT COMMENT "Number of spatially-coincident detections falling within 1.5 arcsec going back to beginning of survey; only detections that fell on the same field and readout-channel ID where the input candidate was observed are counted",
                  ncovhist:INT COMMENT "Number of times input candidate position fell on any field and readout-channel going back to beginning of survey",
                  jdstarthist:DOUBLE COMMENT "Earliest Julian date of epoch corresponding to ndethist [days]",
                  jdendhist:DOUBLE COMMENT "Latest Julian date of epoch corresponding to ndethist [days]",
                  scorr:DOUBLE COMMENT "Peak-pixel signal-to-noise ratio in point source matched-filtered detection image",
                  tooflag:INT COMMENT "1 => candidate is from a Target-of-Opportunity (ToO) exposure; 0 => candidate is from a non-ToO exposure",
                  objectidps1:BIGINT COMMENT "Object ID of closest source from PS1 catalog; if exists within 30 arcsec",
                  objectidps2:BIGINT COMMENT "Object ID of second closest source from PS1 catalog; if exists within 30 arcsec",
                  sgmag2:FLOAT COMMENT "g-band PSF-fit magnitude of second closest source from PS1 catalog; if exists within 30 arcsec [mag]",
                  srmag2:FLOAT COMMENT "r-band PSF-fit magnitude of second closest source from PS1 catalog; if exists within 30 arcsec [mag]",
                  simag2:FLOAT COMMENT "i-band PSF-fit magnitude of second closest source from PS1 catalog; if exists within 30 arcsec [mag]",
                  szmag2:FLOAT COMMENT "z-band PSF-fit magnitude of second closest source from PS1 catalog; if exists within 30 arcsec [mag]",
                  sgscore2:FLOAT COMMENT "Star/Galaxy score of second closest source from PS1 catalog; if exists within 30 arcsec: 0 <= sgscore <= 1 where closer to 1 implies higher likelihood of being a star",
                  distpsnr2:FLOAT COMMENT "Distance to second closest source from PS1 catalog; if exists within 30 arcsec [arcsec]",
                  objectidps3:BIGINT COMMENT "Object ID of third closest source from PS1 catalog; if exists within 30 arcsec",
                  sgmag3:FLOAT COMMENT "g-band PSF-fit magnitude of third closest source from PS1 catalog; if exists within 30 arcsec [mag]",
                  srmag3:FLOAT COMMENT "r-band PSF-fit magnitude of third closest source from PS1 catalog; if exists within 30 arcsec [mag]",
                  simag3:FLOAT COMMENT "i-band PSF-fit magnitude of third closest source from PS1 catalog; if exists within 30 arcsec [mag]",
                  szmag3:FLOAT COMMENT "z-band PSF-fit magnitude of third closest source from PS1 catalog; if exists within 30 arcsec [mag]",
                  sgscore3:FLOAT COMMENT "Star/Galaxy score of third closest source from PS1 catalog; if exists within 30 arcsec: 0 <= sgscore <= 1 where closer to 1 implies higher likelihood of being a star",
                  distpsnr3:FLOAT COMMENT "Distance to third closest source from PS1 catalog; if exists within 30 arcsec [arcsec]",
                  nmtchps:INT COMMENT "Number of source matches from PS1 catalog falling within 30 arcsec",
                  rfid:BIGINT COMMENT "Processing ID for reference image to facilitate archive retrieval",
                  jdstartref:DOUBLE COMMENT "Observation Julian date of earliest exposure used to generate reference image [days]",
                  jdendref:DOUBLE COMMENT "Observation Julian date of latest exposure used to generate reference image [days]",
                  nframesref:INT COMMENT "Number of frames (epochal images) used to generate reference image",
                  rbversion:STRING COMMENT "version of Random Forest classifier model used to assign RealBogus (rb) quality score",
                  dsnrms:FLOAT COMMENT "Ratio: D/stddev(D) on event position where D = difference image",
                  ssnrms:FLOAT COMMENT "Ratio: S/stddev(S) on event position where S = image of convolution: D (x) PSF(D)",
                  dsdiff:FLOAT COMMENT "Difference of statistics: dsnrms - ssnrms",
                  magzpsci:FLOAT COMMENT "Magnitude zero point for photometry estimates [mag]",
                  magzpsciunc:FLOAT COMMENT "Magnitude zero point uncertainty (in magzpsci) [mag]",
                  magzpscirms:FLOAT COMMENT "RMS (deviation from average) in all differences between instrumental photometry and matched photometric calibrators from science image processing [mag]",
                  nmatches:INT COMMENT "Number of PS1 photometric calibrators used to calibrate science image from science image processing",
                  clrcoeff:FLOAT COMMENT "Color coefficient from linear fit from photometric calibration of science image",
                  clrcounc:FLOAT COMMENT "Color coefficient uncertainty from linear fit (corresponding to clrcoeff)",
                  zpclrcov:FLOAT COMMENT "Covariance in magzpsci and clrcoeff from science image processing [mag^2]",
                  zpmed:FLOAT COMMENT "Magnitude zero point from median of all differences between instrumental photometry and matched photometric calibrators from science image processing [mag]",
                  clrmed:FLOAT COMMENT "Median color of all PS1 photometric calibrators used from science image processing [mag]: for filter (fid) = 1, 2, 3, PS1 color used = g-r, g-r, r-i respectively",
                  clrrms:FLOAT COMMENT "RMS color (deviation from average) of all PS1 photometric calibrators used from science image processing [mag]",
                  neargaia:FLOAT COMMENT "Distance to closest source from Gaia DR1 catalog irrespective of magnitude; if exists within 90 arcsec [arcsec]",
                  neargaiabright:FLOAT COMMENT "Distance to closest source from Gaia DR1 catalog brighter than magnitude 14; if exists within 90 arcsec [arcsec]",
                  maggaia:FLOAT COMMENT "Gaia (G-band) magnitude of closest source from Gaia DR1 catalog irrespective of magnitude; if exists within 90 arcsec [mag]",
                  maggaiabright:FLOAT COMMENT "Gaia (G-band) magnitude of closest source from Gaia DR1 catalog brighter than magnitude 14; if exists within 90 arcsec [mag]",
                  exptime:FLOAT COMMENT "Integration time of camera exposure [sec]",
                  drb:FLOAT COMMENT "RealBogus quality score from Deep-Learning-based classifier; range is 0 to 1 where closer to 1 is more reliable",
                  drbversion:STRING COMMENT "version of Deep-Learning-based classifier model used to assign RealBogus (drb) quality score"
              >,
              cutoutScience STRUCT<
                  fileName:STRING,
                  stampData:STRING COMMENT "fits.gz"
              >,
              cutoutTemplate STRUCT<
                  fileName:STRING,
                  stampData:STRING COMMENT "fits.gz"
              >,
              cutoutDifference STRUCT<
                  fileName:STRING,
                  stampData:STRING COMMENT "fits.gz"
              >
          ) 
          ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.avro.AvroSerDe' 
          WITH SERDEPROPERTIES (
              'avro.schema.literal' = '
                {"type":"record","name":"alert","namespace":"ztf","doc":"avro alert schema for ZTF (www.ztf.caltech.edu)","fields":[{"name":"schemavsn","type":"string","doc":"schema version used"},{"name":"publisher","type":"string","doc":"origin of alert packet"},{"name":"objectId","type":"string","doc":"object identifier or name"},{"name":"candid","type":"long"},{"name":"candidate","type":{"type":"record","name":"candidate","namespace":"ztf.alert","doc":"avro alert schema","fields":[{"name":"jd","type":"double","doc":"Observation Julian date at start of exposure [days]"},{"name":"fid","type":"int","doc":"Filter ID (1=g; 2=R; 3=i)"},{"name":"pid","type":"long","doc":"Processing ID for science image to facilitate archive retrieval"},{"name":"diffmaglim","type":["null","float"],"doc":"Expected 5-sigma mag limit in difference image based on global noise estimate [mag]","default":null},{"name":"pdiffimfilename","type":["null","string"],"doc":"filename of positive (sci minus ref) difference image","default":null},{"name":"programpi","type":["null","string"],"doc":"Principal investigator attached to program ID","default":null},{"name":"programid","type":"int","doc":"Program ID: encodes either public, collab, or caltech mode"},{"name":"candid","type":"long","doc":"Candidate ID from operations DB"},{"name":"isdiffpos","type":"string","doc":"t or 1 => candidate is from positive (sci minus ref) subtraction; f or 0 => candidate is from negative (ref minus sci) subtraction"},{"name":"tblid","type":["null","long"],"doc":"Internal pipeline table extraction ID","default":null},{"name":"nid","type":["null","int"],"doc":"Night ID","default":null},{"name":"rcid","type":["null","int"],"doc":"Readout channel ID [00 .. 63]","default":null},{"name":"field","type":["null","int"],"doc":"ZTF field ID","default":null},{"name":"xpos","type":["null","float"],"doc":"x-image position of candidate [pixels]","default":null},{"name":"ypos","type":["null","float"],"doc":"y-image position of candidate [pixels]","default":null},{"name":"ra","type":"double","doc":"Right Ascension of candidate; J2000 [deg]"},{"name":"dec","type":"double","doc":"Declination of candidate; J2000 [deg]"},{"name":"magpsf","type":"float","doc":"Magnitude from PSF-fit photometry [mag]"},{"name":"sigmapsf","type":"float","doc":"1-sigma uncertainty in magpsf [mag]"},{"name":"chipsf","type":["null","float"],"doc":"Reduced chi-square for PSF-fit","default":null},{"name":"magap","type":["null","float"],"doc":"Aperture mag using 14 pixel diameter aperture [mag]","default":null},{"name":"sigmagap","type":["null","float"],"doc":"1-sigma uncertainty in magap [mag]","default":null},{"name":"distnr","type":["null","float"],"doc":"distance to nearest source in reference image PSF-catalog [pixels]","default":null},{"name":"magnr","type":["null","float"],"doc":"magnitude of nearest source in reference image PSF-catalog [mag]","default":null},{"name":"sigmagnr","type":["null","float"],"doc":"1-sigma uncertainty in magnr [mag]","default":null},{"name":"chinr","type":["null","float"],"doc":"DAOPhot chi parameter of nearest source in reference image PSF-catalog","default":null},{"name":"sharpnr","type":["null","float"],"doc":"DAOPhot sharp parameter of nearest source in reference image PSF-catalog","default":null},{"name":"sky","type":["null","float"],"doc":"Local sky background estimate [DN]","default":null},{"name":"magdiff","type":["null","float"],"doc":"Difference: magap - magpsf [mag]","default":null},{"name":"fwhm","type":["null","float"],"doc":"Full Width Half Max assuming a Gaussian core, from SExtractor [pixels]","default":null},{"name":"classtar","type":["null","float"],"doc":"Star/Galaxy classification score from SExtractor","default":null},{"name":"mindtoedge","type":["null","float"],"doc":"Distance to nearest edge in image [pixels]","default":null},{"name":"magfromlim","type":["null","float"],"doc":"Difference: diffmaglim - magap [mag]","default":null},{"name":"seeratio","type":["null","float"],"doc":"Ratio: difffwhm / fwhm","default":null},{"name":"aimage","type":["null","float"],"doc":"Windowed profile RMS afloat major axis from SExtractor [pixels]","default":null},{"name":"bimage","type":["null","float"],"doc":"Windowed profile RMS afloat minor axis from SExtractor [pixels]","default":null},{"name":"aimagerat","type":["null","float"],"doc":"Ratio: aimage / fwhm","default":null},{"name":"bimagerat","type":["null","float"],"doc":"Ratio: bimage / fwhm","default":null},{"name":"elong","type":["null","float"],"doc":"Ratio: aimage / bimage","default":null},{"name":"nneg","type":["null","int"],"doc":"number of negative pixels in a 5 x 5 pixel stamp","default":null},{"name":"nbad","type":["null","int"],"doc":"number of prior-tagged bad pixels in a 5 x 5 pixel stamp","default":null},{"name":"rb","type":["null","float"],"doc":"RealBogus quality score from Random Forest classifier; range is 0 to 1 where closer to 1 is more reliable","default":null},{"name":"ssdistnr","type":["null","float"],"doc":"distance to nearest known solar system object if exists within 30 arcsec [arcsec]","default":null},{"name":"ssmagnr","type":["null","float"],"doc":"magnitude of nearest known solar system object if exists within 30 arcsec (usually V-band from MPC archive) [mag]","default":null},{"name":"ssnamenr","type":["null","string"],"doc":"name of nearest known solar system object if exists within 30 arcsec (from MPC archive)","default":null},{"name":"sumrat","type":["null","float"],"doc":"Ratio: sum(pixels) / sum(|pixels|) in a 5 x 5 pixel stamp where stamp is first median-filtered to mitigate outliers","default":null},{"name":"magapbig","type":["null","float"],"doc":"Aperture mag using 18 pixel diameter aperture [mag]","default":null},{"name":"sigmagapbig","type":["null","float"],"doc":"1-sigma uncertainty in magapbig [mag]","default":null},{"name":"ranr","type":"double","doc":"Right Ascension of nearest source in reference image PSF-catalog; J2000 [deg]"},{"name":"decnr","type":"double","doc":"Declination of nearest source in reference image PSF-catalog; J2000 [deg]"},{"name":"sgmag1","type":["null","float"],"doc":"g-band PSF-fit magnitude of closest source from PS1 catalog; if exists within 30 arcsec [mag]","default":null},{"name":"srmag1","type":["null","float"],"doc":"r-band PSF-fit magnitude of closest source from PS1 catalog; if exists within 30 arcsec [mag]","default":null},{"name":"simag1","type":["null","float"],"doc":"i-band PSF-fit magnitude of closest source from PS1 catalog; if exists within 30 arcsec [mag]","default":null},{"name":"szmag1","type":["null","float"],"doc":"z-band PSF-fit magnitude of closest source from PS1 catalog; if exists within 30 arcsec [mag]","default":null},{"name":"sgscore1","type":["null","float"],"doc":"Star/Galaxy score of closest source from PS1 catalog; if exists within 30 arcsec: 0 <= sgscore <= 1 where closer to 1 implies higher likelihood of being a star","default":null},{"name":"distpsnr1","type":["null","float"],"doc":"Distance to closest source from PS1 catalog; if exists within 30 arcsec [arcsec]","default":null},{"name":"ndethist","type":"int","doc":"Number of spatially-coincident detections falling within 1.5 arcsec going back to beginning of survey; only detections that fell on the same field and readout-channel ID where the input candidate was observed are counted"},{"name":"ncovhist","type":"int","doc":"Number of times input candidate position fell on any field and readout-channel going back to beginning of survey"},{"name":"jdstarthist","type":["null","double"],"doc":"Earliest Julian date of epoch corresponding to ndethist [days]","default":null},{"name":"jdendhist","type":["null","double"],"doc":"Latest Julian date of epoch corresponding to ndethist [days]","default":null},{"name":"scorr","type":["null","double"],"doc":"Peak-pixel signal-to-noise ratio in point source matched-filtered detection image","default":null},{"name":"tooflag","type":["null","int"],"doc":"1 => candidate is from a Target-of-Opportunity (ToO) exposure; 0 => candidate is from a non-ToO exposure","default":0},{"name":"objectidps1","type":["null","long"],"doc":"Object ID of closest source from PS1 catalog; if exists within 30 arcsec","default":null},{"name":"objectidps2","type":["null","long"],"doc":"Object ID of second closest source from PS1 catalog; if exists within 30 arcsec","default":null},{"name":"sgmag2","type":["null","float"],"doc":"g-band PSF-fit magnitude of second closest source from PS1 catalog; if exists within 30 arcsec [mag]","default":null},{"name":"srmag2","type":["null","float"],"doc":"r-band PSF-fit magnitude of second closest source from PS1 catalog; if exists within 30 arcsec [mag]","default":null},{"name":"simag2","type":["null","float"],"doc":"i-band PSF-fit magnitude of second closest source from PS1 catalog; if exists within 30 arcsec [mag]","default":null},{"name":"szmag2","type":["null","float"],"doc":"z-band PSF-fit magnitude of second closest source from PS1 catalog; if exists within 30 arcsec [mag]","default":null},{"name":"sgscore2","type":["null","float"],"doc":"Star/Galaxy score of second closest source from PS1 catalog; if exists within 30 arcsec: 0 <= sgscore <= 1 where closer to 1 implies higher likelihood of being a star","default":null},{"name":"distpsnr2","type":["null","float"],"doc":"Distance to second closest source from PS1 catalog; if exists within 30 arcsec [arcsec]","default":null},{"name":"objectidps3","type":["null","long"],"doc":"Object ID of third closest source from PS1 catalog; if exists within 30 arcsec","default":null},{"name":"sgmag3","type":["null","float"],"doc":"g-band PSF-fit magnitude of third closest source from PS1 catalog; if exists within 30 arcsec [mag]","default":null},{"name":"srmag3","type":["null","float"],"doc":"r-band PSF-fit magnitude of third closest source from PS1 catalog; if exists within 30 arcsec [mag]","default":null},{"name":"simag3","type":["null","float"],"doc":"i-band PSF-fit magnitude of third closest source from PS1 catalog; if exists within 30 arcsec [mag]","default":null},{"name":"szmag3","type":["null","float"],"doc":"z-band PSF-fit magnitude of third closest source from PS1 catalog; if exists within 30 arcsec [mag]","default":null},{"name":"sgscore3","type":["null","float"],"doc":"Star/Galaxy score of third closest source from PS1 catalog; if exists within 30 arcsec: 0 <= sgscore <= 1 where closer to 1 implies higher likelihood of being a star","default":null},{"name":"distpsnr3","type":["null","float"],"doc":"Distance to third closest source from PS1 catalog; if exists within 30 arcsec [arcsec]","default":null},{"name":"nmtchps","type":"int","doc":"Number of source matches from PS1 catalog falling within 30 arcsec"},{"name":"rfid","type":"long","doc":"Processing ID for reference image to facilitate archive retrieval"},{"name":"jdstartref","type":"double","doc":"Observation Julian date of earliest exposure used to generate reference image [days]"},{"name":"jdendref","type":"double","doc":"Observation Julian date of latest exposure used to generate reference image [days]"},{"name":"nframesref","type":"int","doc":"Number of frames (epochal images) used to generate reference image"},{"name":"rbversion","type":"string","doc":"version of Random Forest classifier model used to assign RealBogus (rb) quality score"},{"name":"dsnrms","type":["null","float"],"doc":"Ratio: D/stddev(D) on event position where D = difference image","default":null},{"name":"ssnrms","type":["null","float"],"doc":"Ratio: S/stddev(S) on event position where S = image of convolution: D (x) PSF(D)","default":null},{"name":"dsdiff","type":["null","float"],"doc":"Difference of statistics: dsnrms - ssnrms","default":null},{"name":"magzpsci","type":["null","float"],"doc":"Magnitude zero point for photometry estimates [mag]","default":null},{"name":"magzpsciunc","type":["null","float"],"doc":"Magnitude zero point uncertainty (in magzpsci) [mag]","default":null},{"name":"magzpscirms","type":["null","float"],"doc":"RMS (deviation from average) in all differences between instrumental photometry and matched photometric calibrators from science image processing [mag]","default":null},{"name":"nmatches","type":"int","doc":"Number of PS1 photometric calibrators used to calibrate science image from science image processing"},{"name":"clrcoeff","type":["null","float"],"doc":"Color coefficient from linear fit from photometric calibration of science image","default":null},{"name":"clrcounc","type":["null","float"],"doc":"Color coefficient uncertainty from linear fit (corresponding to clrcoeff)","default":null},{"name":"zpclrcov","type":["null","float"],"doc":"Covariance in magzpsci and clrcoeff from science image processing [mag^2]","default":null},{"name":"zpmed","type":["null","float"],"doc":"Magnitude zero point from median of all differences between instrumental photometry and matched photometric calibrators from science image processing [mag]","default":null},{"name":"clrmed","type":["null","float"],"doc":"Median color of all PS1 photometric calibrators used from science image processing [mag]: for filter (fid) = 1, 2, 3, PS1 color used = g-r, g-r, r-i respectively","default":null},{"name":"clrrms","type":["null","float"],"doc":"RMS color (deviation from average) of all PS1 photometric calibrators used from science image processing [mag]","default":null},{"name":"neargaia","type":["null","float"],"doc":"Distance to closest source from Gaia DR1 catalog irrespective of magnitude; if exists within 90 arcsec [arcsec]","default":null},{"name":"neargaiabright","type":["null","float"],"doc":"Distance to closest source from Gaia DR1 catalog brighter than magnitude 14; if exists within 90 arcsec [arcsec]","default":null},{"name":"maggaia","type":["null","float"],"doc":"Gaia (G-band) magnitude of closest source from Gaia DR1 catalog irrespective of magnitude; if exists within 90 arcsec [mag]","default":null},{"name":"maggaiabright","type":["null","float"],"doc":"Gaia (G-band) magnitude of closest source from Gaia DR1 catalog brighter than magnitude 14; if exists within 90 arcsec [mag]","default":null},{"name":"exptime","type":["null","float"],"doc":"Integration time of camera exposure [sec]","default":null},{"name":"drb","type":["null","float"],"doc":"RealBogus quality score from Deep-Learning-based classifier; range is 0 to 1 where closer to 1 is more reliable","default":null},{"name":"drbversion","type":"string","doc":"version of Deep-Learning-based classifier model used to assign RealBogus (drb) quality score"}],"version":"3.3"}},{"name":"prv_candidates","type":["null",{"type":"array","items":{"type":"record","name":"prv_candidate","namespace":"ztf.alert","doc":"avro alert schema","fields":[{"name":"jd","type":"double","doc":"Observation Julian date at start of exposure [days]"},{"name":"fid","type":"int","doc":"Filter ID (1=g; 2=R; 3=i)"},{"name":"pid","type":"long","doc":"Processing ID for image"},{"name":"diffmaglim","type":["null","float"],"doc":"Expected 5-sigma mag limit in difference image based on global noise estimate [mag]","default":null},{"name":"pdiffimfilename","type":["null","string"],"doc":"filename of positive (sci minus ref) difference image","default":null},{"name":"programpi","type":["null","string"],"doc":"Principal investigator attached to program ID","default":null},{"name":"programid","type":"int","doc":"Program ID: encodes either public, collab, or caltech mode"},{"name":"candid","type":["null","long"],"doc":"Candidate ID from operations DB"},{"name":"isdiffpos","type":["null","string"],"doc":"t or 1 => candidate is from positive (sci minus ref) subtraction; f or 0 => candidate is from negative (ref minus sci) subtraction"},{"name":"tblid","type":["null","long"],"doc":"Internal pipeline table extraction ID","default":null},{"name":"nid","type":["null","int"],"doc":"Night ID","default":null},{"name":"rcid","type":["null","int"],"doc":"Readout channel ID [00 .. 63]","default":null},{"name":"field","type":["null","int"],"doc":"ZTF field ID","default":null},{"name":"xpos","type":["null","float"],"doc":"x-image position of candidate [pixels]","default":null},{"name":"ypos","type":["null","float"],"doc":"y-image position of candidate [pixels]","default":null},{"name":"ra","type":["null","double"],"doc":"Right Ascension of candidate; J2000 [deg]"},{"name":"dec","type":["null","double"],"doc":"Declination of candidate; J2000 [deg]"},{"name":"magpsf","type":["null","float"],"doc":"Magnitude from PSF-fit photometry [mag]"},{"name":"sigmapsf","type":["null","float"],"doc":"1-sigma uncertainty in magpsf [mag]"},{"name":"chipsf","type":["null","float"],"doc":"Reduced chi-square for PSF-fit","default":null},{"name":"magap","type":["null","float"],"doc":"Aperture mag using 14 pixel diameter aperture [mag]","default":null},{"name":"sigmagap","type":["null","float"],"doc":"1-sigma uncertainty in magap [mag]","default":null},{"name":"distnr","type":["null","float"],"doc":"distance to nearest source in reference image PSF-catalog [pixels]","default":null},{"name":"magnr","type":["null","float"],"doc":"magnitude of nearest source in reference image PSF-catalog [mag]","default":null},{"name":"sigmagnr","type":["null","float"],"doc":"1-sigma uncertainty in magnr [mag]","default":null},{"name":"chinr","type":["null","float"],"doc":"DAOPhot chi parameter of nearest source in reference image PSF-catalog","default":null},{"name":"sharpnr","type":["null","float"],"doc":"DAOPhot sharp parameter of nearest source in reference image PSF-catalog","default":null},{"name":"sky","type":["null","float"],"doc":"Local sky background estimate [DN]","default":null},{"name":"magdiff","type":["null","float"],"doc":"Difference: magap - magpsf [mag]","default":null},{"name":"fwhm","type":["null","float"],"doc":"Full Width Half Max assuming a Gaussian core, from SExtractor [pixels]","default":null},{"name":"classtar","type":["null","float"],"doc":"Star/Galaxy classification score from SExtractor","default":null},{"name":"mindtoedge","type":["null","float"],"doc":"Distance to nearest edge in image [pixels]","default":null},{"name":"magfromlim","type":["null","float"],"doc":"Difference: diffmaglim - magap [mag]","default":null},{"name":"seeratio","type":["null","float"],"doc":"Ratio: difffwhm / fwhm","default":null},{"name":"aimage","type":["null","float"],"doc":"Windowed profile RMS afloat major axis from SExtractor [pixels]","default":null},{"name":"bimage","type":["null","float"],"doc":"Windowed profile RMS afloat minor axis from SExtractor [pixels]","default":null},{"name":"aimagerat","type":["null","float"],"doc":"Ratio: aimage / fwhm","default":null},{"name":"bimagerat","type":["null","float"],"doc":"Ratio: bimage / fwhm","default":null},{"name":"elong","type":["null","float"],"doc":"Ratio: aimage / bimage","default":null},{"name":"nneg","type":["null","int"],"doc":"number of negative pixels in a 5 x 5 pixel stamp","default":null},{"name":"nbad","type":["null","int"],"doc":"number of prior-tagged bad pixels in a 5 x 5 pixel stamp","default":null},{"name":"rb","type":["null","float"],"doc":"RealBogus quality score; range is 0 to 1 where closer to 1 is more reliable","default":null},{"name":"ssdistnr","type":["null","float"],"doc":"distance to nearest known solar system object if exists within 30 arcsec [arcsec]","default":null},{"name":"ssmagnr","type":["null","float"],"doc":"magnitude of nearest known solar system object if exists within 30 arcsec (usually V-band from MPC archive) [mag]","default":null},{"name":"ssnamenr","type":["null","string"],"doc":"name of nearest known solar system object if exists within 30 arcsec (from MPC archive)","default":null},{"name":"sumrat","type":["null","float"],"doc":"Ratio: sum(pixels) / sum(|pixels|) in a 5 x 5 pixel stamp where stamp is first median-filtered to mitigate outliers","default":null},{"name":"magapbig","type":["null","float"],"doc":"Aperture mag using 18 pixel diameter aperture [mag]","default":null},{"name":"sigmagapbig","type":["null","float"],"doc":"1-sigma uncertainty in magapbig [mag]","default":null},{"name":"ranr","type":["null","double"],"doc":"Right Ascension of nearest source in reference image PSF-catalog; J2000 [deg]"},{"name":"decnr","type":["null","double"],"doc":"Declination of nearest source in reference image PSF-catalog; J2000 [deg]"},{"name":"scorr","type":["null","double"],"doc":"Peak-pixel signal-to-noise ratio in point source matched-filtered detection image","default":null},{"name":"magzpsci","type":["null","float"],"doc":"Magnitude zero point for photometry estimates [mag]","default":null},{"name":"magzpsciunc","type":["null","float"],"doc":"Magnitude zero point uncertainty (in magzpsci) [mag]","default":null},{"name":"magzpscirms","type":["null","float"],"doc":"RMS (deviation from average) in all differences between instrumental photometry and matched photometric calibrators from science image processing [mag]","default":null},{"name":"clrcoeff","type":["null","float"],"doc":"Color coefficient from linear fit from photometric calibration of science image","default":null},{"name":"clrcounc","type":["null","float"],"doc":"Color coefficient uncertainty from linear fit (corresponding to clrcoeff)","default":null},{"name":"rbversion","type":"string","doc":"version of RealBogus model/classifier used to assign rb quality score"}],"version":"3.3"}}],"default":null},{"name":"cutoutScience","type":["null",{"type":"record","name":"cutout","namespace":"ztf.alert","doc":"avro alert schema","fields":[{"name":"fileName","type":"string"},{"name":"stampData","type":"bytes","doc":"fits.gz"}],"version":"3.3"}],"default":null},{"name":"cutoutTemplate","type":["null","ztf.alert.cutout"],"default":null},{"name":"cutoutDifference","type":["null","ztf.alert.cutout"],"default":null}],"version":"3.3"}
          ') STORED AS AVRO LOCATION 's3://${Bucket}/avro_files/';

  Trail: 
    Type: AWS::CloudTrail::Trail
    DependsOn: LogsBucketPolicy
    Properties: 
      S3BucketName:
        Ref: LogsBucket
      IsLogging: false
      Tags:
        - Key: PLATFORM
          Value: SAPC01

  LogsBucket: 
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    Properties:
      Tags:
        - Key: PLATFORM
          Value: SAPC01

  LogsBucketPolicy: 
    Type: AWS::S3::BucketPolicy
    Properties: 
      Bucket: 
        Ref: LogsBucket
      PolicyDocument: 
        Version: 2012-10-17
        Statement:
        - Sid: AWSCloudTrailAclCheck20150319
          Effect: Allow
          Principal:
            Service: cloudtrail.amazonaws.com
          Action: s3:GetBucketAcl
          Resource: 
            Fn::GetAtt: LogsBucket.Arn
        - Sid: AWSCloudTrailWrite20150319
          Effect: Allow
          Principal:
            Service: cloudtrail.amazonaws.com
          Action: s3:PutObject
          Resource: 
            Fn::Sub: "${LogsBucket.Arn}/AWSLogs/${AWS::AccountId}/*"
          Condition:
            StringEquals:
              s3:x-amz-acl: bucket-owner-full-control

Outputs:

  Bucket:
    Description: The Bucket
    Value: 
      Ref: Bucket

  LogsBucket:
    Description: The LogsBucket
    Value: 
      Ref: LogsBucket
